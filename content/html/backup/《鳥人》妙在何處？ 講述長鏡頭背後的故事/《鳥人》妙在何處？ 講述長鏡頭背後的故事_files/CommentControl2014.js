var CommentControl2014=Class.create();Object.extend(CommentControl2014.prototype,{options:{commentObjId:0,cmsRelatedObjType:-1,commentRegion:null,commentRelatedObjType:-1,isDetailPage:true,allowAnonymousComment:true,moreCommentUrl:"#",pageIndex:1,pageSize:10,hasSynTwitterCheckbox:false,synTwitter:false,isStaticComment:false,getCommentListCallback:function(){},addCommentCallback:function(){},deleteCommentCallback:function(){}},setOptions:function(a){Object.extend(Object.extend(this,this.options),a)},server:{getUserInfo:function(a){return Mtime.Component.Ajax.crossDomainCallBack(siteLibraryServiceUrl,"Mtime.Library.Services","GetUserInfo",[],a,"/Movie.api","get","60000")},refreshVcode:function(a){return Mtime.Component.Ajax.crossDomainCallBack(siteServiceUrl,"Mtime.Service.Pages.UserService","RefreshVcode",[],a,"/Service/User.msi","get","60000")}},initialize:function(a){this.setOptions(a);this.initializeServerData();this.initializeDOM();this.initializeEvent();this.initializeControl();this.load()},initializeServerData:function(){},initializeDOM:function(){this.commentRegion=$(this.commentRegion)},destroyDOM:function(){this.commentList=null;this.commentRegion=null},initializeEvent:function(){Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){if(this.commentList){this.commentList.stopObserving("click",this.onClickCommentListHandler)}if(this.commentBoxArea){this.commentBoxArea.stopObserving("click",this.onClickCommentBoxAreaHandler)}},initializeControl:function(){},destroyControl:function(){},load:function(){if(this.commentObjId===0){return}this.operateDom="";if(this.cmsRelatedObjType>-1&&!this.isDetailPage&&!this.isStaticComment){this.operateDom='<a href="#" method="edit">编辑</a> | <a href="#" method="del">删除</a>'}this.orderType=1;this.commentTotalCount=0;if(!this.isStaticComment){this.renderCommentRegion();this.renderControlInfo();this.renderUserInfo();this.renderComment(this.pageIndex)}else{this.renderControlInfo();this.renderUserInfo();var c=$("totalComments");var a=$("commentCount");if(c){var b=parseInt(c.innerHTML,10);if(a){a.innerHTML=b;if(b==0){a.up().addClassName("none")}}if(moreCommentUrl!=undefined){c.href=moreCommentUrl;if($("moreCommentUrl")){$("moreCommentUrl").href=moreCommentUrl}}if(this.commentList){if(b==0){this.commentList.up().hide()}else{this.commentList.up().show()}}}$loadSubJs(["/News/NewsCommentCtrl.js"],function(){this.newsCommentCtrl=new NewsCommentCtrl({commentRegionId:"commentRegion",newsId:this.commentObjId,newsTitle:document.title.split("–")[0],newsUrl:location.href})}.bind(this));this.intizeCommentPubTime()}},intizeCommentPubTime:function(){var c=$$("p[entertime]");c.concat($$("span[entertime]"));if(typeof c!="undefined"&&c.length>0){for(var a=0;a<c.length;a++){var b=c[a];var d=b.readAttribute("entertime");if(!Mtime.isEmpty(d)){var e=this.getCommentPubTime(d);b.innerHTML=e}}}},getCommentPubTime:function(b){var a=Mtime.parseDate(b);if(!a){a=new Date()}return Mtime.dateToFormatedStringNoTag(a)},renderCommentRegion:function(){var a=new StringBuilder();a.append('<a name="comment"></a>');if(this.isDetailPage){a.append('<h3>会员评论 <span id="totalCountRegion">(<a href="'+this.moreCommentUrl+'" id="totalComments"></a>)</span></h3>')}else{a.append("<h3>会员评论</h3>")}a.append('            <div class="ele_bbsarea clearfix">');a.append('            	<div class="ele_bbsuser" id="userArea">');a.append("                </div>");a.append('                <div class="ele_bbstextarea" id="commentBoxArea">');a.append('                   <textarea class="c_a5 ele_textarea" id="commentConTextArea"></textarea>');a.append('                    <p class="mt9 clearfix"><span class="c_red fl ml9 pt6" id="msg"></span>');a.append('                        <div class="mt9">');a.append('                            <p style="display:none;" class="mb12" id="vArea">验证码：<input type="text" style="width:90px;" id="vText" method="code" class="c_a5" value="点击获取验证码"><span id="vimgArea"></span></p>');a.append('                            <span style="display:none;" id="synTwitter">');if(this.hasSynTwitterCheckbox){if(this.synTwitter){a.append('                        <input type="checkbox" checked="checked"  id="synTwitterCheckbox" /><label class="ml6 c_8e px12">转发至我的微评</label>')}else{a.append('                        <input type="checkbox" id="synTwitterCheckbox" /><label class="ml6 c_8e px12">转发至我的微评</label>')}}a.append("                            </span>");a.append('                            <a href="javascript:void(0);" method="submit" class="btn_dblue">发 表</a>');a.append("                        </div>");a.append("                    </p>");a.append("                </div>");a.append("             </div>");a.append('<div class="ele_bbslist" style="display:none;">');if(this.cmsRelatedObjType>-1&&!this.isDetailPage&&!this.isStaticComment){a.append('<div class="pt25" id="orderRegion">排列方式：<a href="javascript:void(0);" type="hot">热门</a> | 最新</div>')}a.append('<dl id="commentList"></dl>');a.append('<div id="pageRegion" class="mt30 pb30"></div>');a.append("</div>");this.commentRegion.innerHTML=a.toString()},renderControlInfo:function(){this.commentBoxArea=$("commentBoxArea");this.commentList=$("commentList");this.orderRegion=$("orderRegion");if(!this.isDetailPage){this.pageRegion=$("pageRegion")}this.userArea=$("userArea");if(this.commentBoxArea){this.onClickCommentBoxAreaHandler=this.onClickCommentBoxArea.bindAsEventListener(this);this.commentBoxArea.observe("click",this.onClickCommentBoxAreaHandler)}if(this.commentList){this.onClickCommentListHandler=this.onClickCommentList.bindAsEventListener(this);this.commentList.observe("click",this.onClickCommentListHandler)}if(this.orderRegion){this.onClickOrderRegionHandler=this.onClickOrderRegion.bind(this);this.orderRegion.observe("click",this.onClickOrderRegionHandler)}this.commentBox=new Textbox({text:this.commentBoxArea.down("textarea"),watermarkText:"发表简短评论...",focusClassName:"",blurClassName:"c_a5"});this.commentListRegion=this.commentRegion.down("div.ele_bbslist")},onClickOrderRegion:function(b){var a=Event.element(b);if(a.tagName=="A"){var c=a.readAttribute("type");if(c=="hot"||c=="new"){if(c=="hot"){this.orderType=2;this.orderRegion.innerHTML='排列方式：热门 | <a href="javascript:void(0);" type="new">最新</a>'}else{this.orderType=1;this.orderRegion.innerHTML='排列方式：<a href="javascript:void(0);" type="hot">热门</a> | 最新'}this.renderComment(1)}}},renderUserInfo:function(){this.server.getUserInfo(function(a){if(a&&a.value){var b;this.userInfo=a.value;if(a.value.isAnonymous){b=new Template('<img width="48" height="48" alt="匿名" src="#{avatarUrl}"><p class="mt5">匿名</p>');if(this.allowAnonymousComment){$("vArea").show()}$("synTwitter").innerHTML=""}else{b=new Template('<a title="#{nickName}" target="_blank" href="#{homeUrl}"><img width="48" height="48" alt="#{nickName}" src="#{avatarUrl}"></a><p class="mt6"><a target="_blank" href="#{homeUrl}">#{nickName}</a></p>');if(this.hasSynTwitterCheckbox){$("synTwitter").show()}}if(this.userArea){this.userArea.innerHTML=b.evaluate(a.value)}}}.bind(this))},getCommentTemplate:function(b){var a=new StringBuilder();a.append('                <dd commentid="#{commentId}" expend="0" loaded="0">');a.append('                	<i class="line"></i>');a.append('                    <div class="user_box">');if(b){a.append('<img width="48" height="48" alt="#{nickName}" src="#{avatarUrl}">');a.append('<p class="mt5">匿名</p>')}else{a.append('<a title="#{nickName}" target="_blank" href="#{homeUrl}"><img width="48" height="48" alt="#{nickName}" src="#{avatarUrl}"></a>');a.append('<p class="mt5"><a target="_blank" href="#{homeUrl}">#{nickName}</a></p>')}a.append('                        <p class="mt6">#{enterTime}</p>');a.append("                    </div>");a.append('                    <div class="user_cont">');a.append('                        <div class="user_conter">');a.append('                            <p class="px14 lh18">#{content}</p>');a.append('                            <div class="ele_replay clearfix">');a.append('                                <div class="textarea" style="height: 30px;">');a.append('                                    <textarea method="comment" id="tbox#{commentId}" class="c_a5" toggle="0" style="height: 30px;">发表评论</textarea>');a.append("                                    <i></i>");a.append("                                </div>");a.append('                                <div class="db_comtool tr mt20" commentid="#{commentId}"> ');a.append('                                    <a method="praise" onclick="return false;" href="#" title="赞" class="com_good"><i title="赞"></i>0</a> ');a.append('                                    <a method="share" onclick="return false;" href="#" title="转发" class="com_share"><i title="转发"></i>0</a> ');a.append('                                    <a href="#" onclick="return false;" method="comment2" title="评论" class="com_bbs"><i title="评论"></i>#{replyCount}</a> ');a.append("                                </div>");a.append("                            </div>");a.append("                            <ul>#{repliesHtml}</ul>");a.append("                        </div>");a.append("                    </div>");a.append("                </dd>");return a.toString()},getReplyTemplate:function(b){var a=new StringBuilder();a.append('                                <li commentid="#{commentId}">');if(b){a.append('<div class="user_box"><img width="32" height="32" alt="#{nickName}" src="#{avatarUrl}"></div>');a.append('<p class="px14">匿名<span class="ml15">#{enterTime}</span></p>')}else{a.append('<div class="user_box"><a title="#{nickName}" target="_blank" href="#{homeUrl}"><img width="32" height="32" alt="#{nickName}" src="#{avatarUrl}"></a></div>');a.append('<p class="px14"><a target="_blank" href="#{homeUrl}">#{nickName}</a><span class="ml15">#{enterTime}</span></p>')}a.append('                                    <p class=" lh18 mt3">#{content}</p>');a.append("                                </li>");return a.toString()},renderComment:function(a){this.getCommentListCallback(this.commentObjId,a,this.cmsRelatedObjType,this.orderType,function(f){var e=f.value.comments;this.replies=f.value.replies;this.userId=f.value.userId;var c=new StringBuilder();for(var d=0;d<e.length;d++){if(parseInt(e[d].replyCount,10)>0){e[d].repliesHtml=this.getRepliesHtmlByCommentId(e[d].commentId)}var b=this.getCommentTemplate(e[d].userId===0);var g=new Template(b);if(e[d].userId>0&&e[d].userId==this.userId){e[d].operate=this.operateDom}c.append(g.evaluate(e[d]))}this.commentTotalCount=parseInt(f.value.totalComments);if(this.isDetailPage&&f.value.totalCount>0){c.append('<dt><a href="'+this.moreCommentUrl+'" method="more">更多 <em>'+this.commentTotalCount+'</em> 条评论 <i class="gt"></i></a></dt>')}this.commentList.innerHTML=c.toString();if($("totalComments")){$("totalComments").innerHTML=this.commentTotalCount;if(this.commentTotalCount>0){$("totalComments").up().show()}else{$("totalComments").up().hide()}}this.totalCount=f.value.totalCount;if(f.value.pageSize){this.pageSize=f.value.pageSize}this.renderPager(a);this.commentListRegion=this.commentRegion.down("div.ele_bbslist");if(f.value.totalCount>0){this.commentListRegion.show()}if(this.cmsRelatedObjType>-1){$loadSubJs(["/News/NewsCommentCtrl.js"],function(){var j=$("titleRegion");if(j){var h=j.down("a");if(h){this.newsCommentCtrl=new NewsCommentCtrl({commentRegionId:"commentRegion",newsId:this.commentObjId,newsTitle:h.title,newsUrl:h.href})}}}.bind(this))}else{if(this.commentRelatedObjType>-1){$loadSubJs(["/Comment/CommCommentCtrl.js"],function(){this.commCommentCtrl=new CommCommentCtrl({commentRegionId:"commentRegion",relatedObjType:this.commentRelatedObjType})}.bind(this))}}}.bind(this))},renderPager:function(a){if(this.pageRegion){this.pageIndex=a;var b=new Pager({pageRegionId:this.pageRegion,pageIndex:this.pageIndex,pageSize:this.pageSize,totalRecord:this.totalCount,callback:this.pagerCallback.bind(this)});b.render(this.pageIndex,this.totalCount)}},pagerCallback:function(a){if(a!=this.pageIndex){this.renderComment(a);window.scrollTo(0,200)}},onClickCommentBoxArea:function(c){var a=Event.element(c);if(a!=document&&a.hasAttribute("method")){var d=a.readAttribute("method");switch(d){case"code":if(a.value=="点击获取验证码"){a.value="";this.server.refreshVcode(function(j){if(j&&j.value){$("vimgArea").innerHTML='<img src="'+j.value.src+'" width="90" height="60" class="v_m mr10 ml10" codeid="'+j.value.id+'" /><a href="javascript:void(0)" method="refresh">刷新</a>'}}.bind(this))}break;case"refresh":this.server.refreshVcode(function(j){if(j&&j.value){$("vimgArea").innerHTML='<img src="'+j.value.src+'" width="90" height="60" class="v_m mr10 ml10" codeid="'+j.value.id+'" /><a href="javascript:void(0)" method="refresh">刷新</a>'}}.bind(this));break;case"submit":$("msg").innerHTML="";if(this.userInfo.isAnonymous&&!this.allowAnonymousComment){$("msg").innerHTML="请登录后进行评论";return}var b=this.commentBox.getValue();if(b.trim()===""){$("msg").innerHTML="请输入评论内容";return}if(b.trim().bytelength()>4000){$("msg").innerHTML="评论内容最多为2000个汉字";return}var h=$("vText").value;if($("vArea").visible()&&(h===""||h==="点击获取验证码")){$("msg").innerHTML="请输入验证码";return}var f="";var g=$("vimgArea").down("img");if(g){f=g.readAttribute("codeid")}var e=0;if($("synTwitterCheckbox")&&$("synTwitterCheckbox").checked){e=1}this.addCommentCallback(this.commentObjId,0,-1,b,h,f,e,this.cmsRelatedObjType,a,function(j){if(j.value.commentId){this.completedParentComment(j)}else{if(j.value.status==-105){if(this.userInfo.isAnonymous){$("msg").innerHTML="验证码输入错误"}else{this.showValidDialog(this.commentObjId,0,-1,b,h,f,e,this.cmsRelatedObjType,a)}}else{if(j.value.id){if(!this.userInfo.isAnonymous&&j.value.isUserLogin==false){$alert("请登录后再发表评论");return}$("vText").value="点击获取验证码";$("vimgArea").innerHTML='<img src="'+j.value.src+'" width="90" height="60" class="v_m mr10 ml10" codeid="'+j.value.id+'" /><a href="#" method="refresh">刷新</a>'}else{$("msg").innerHTML=j.value.msg}}}}.bind(this));break}}},showValidDialog:function(e,d,a,f,j,h,g,c,b){this.changeVcode();new Dialog({windowClassName:"w445",content:Builder.node("div",{className:"ml20 mr20"},[Builder.node("h3",{id:"tip"},["抱歉，连续访问次数过多，为了证明你不是机器人，请输入验证码后继续查询"]),Builder.node("p",{className:"mt10"},[Builder.node("input",{id:"vcodeText",type:"text",className:"w120"}),Builder.node("img",{id:"vcodeImage",src:""+this.vcodeSrc+"",alt:"验证码",className:"v_m mlr10"}),Builder.node("a",{href:"#",id:"changeVcodeLink",onclick:"return false;"},["看不清楚？换一张"])])]),buttonRegionClass:"mt10 pb15 ml20",buttons:[{title:"确定",buttonStyle:"btn_square_hover mr15",callback:function(k){var l=k.getEl("vcodeText").value;l=l.trim();if(l.length>0){this.addCommentCallback(e,d,a,f,l,this.vcodeId,g,this.cmsRelatedObjType,b,function(m){if(m.value.commentId){k.close();if(d==0){this.completedParentComment(m)}else{this.completedChildComment(m,d,b)}}else{$alert("验证码输入错误");this.changeVcode()}}.bind(this))}else{$alert("请输入验证码！")}}.bind(this)}],readyCallback:this.onShowValidDialogReady.bind(this),closeCallback:this.onShowValidDialogClose.bind(this)})},onShowValidDialogReady:function(a){this.changeVcodeLink=a.getEl("changeVcodeLink");this.vcodeImage=a.getEl("vcodeImage");this.onClickChangeVcodeLinkHandler=this.changeVcode.bind(this);this.changeVcodeLink.observe("click",this.onClickChangeVcodeLinkHandler)},changeVcode:function(){this.server.refreshVcode(function(a){this.vcodeSrc=a.value.src;this.vcodeId=a.value.id;this.vcodeImage.src=this.vcodeSrc}.bind(this))},onShowValidDialogClose:function(){this.changeVcodeLink.stopObserving("click",this.onClickChangeVcodeLinkHandler);this.changeVcodeLink=null;this.vcodeImage=null;this.isRobotActive=false},completedParentComment:function(c){this.commentBox.setValue("");var a=this.userInfo;a.commentId=c.value.commentId;a.content=c.value.cleanBody;a.replyCount=0;a.enterTime="刚刚";var b=this.getCommentTemplate(a.isAnonymous);var d=new Template(b);if(this.userInfo.userId>0){a.operate=this.operateDom}this.commentList.innerHTML=d.evaluate(a)+this.commentList.innerHTML;this.commentListRegion.show();if(this.isDetailPage){$("totalComments").innerHTML=parseInt($("totalComments").innerHTML,10)+1;$("totalComments").up().show();$("totalComments").up().removeClassName("none")}$("vText").value="点击获取验证码";$("vimgArea").innerHTML=""},completedChildComment:function(l,d,a){if(a.hasAttribute("operate")){var g=a.up("li");if(g&&g.hasAttribute("commentid")){d=g.readAttribute("commentid")}var c=$("tboxOperate"+d);c.up("div").previous().innerHTML=c.value.trim();this.cancelOperateCommentAreaBox(d)}else{this.commentBox.setValue("");var b=this.userInfo;b.commentId=l.value.commentId;b.content=l.value.cleanBody;b.replyCount=0;b.enterTime="刚刚";var k=this.getReplyTemplate(b.isAnonymous);var m=new Template(k);var f=a.up("dd");var e=f.getElementsBySelector("ul")[0];if(this.userInfo.userId>0){b.operate=this.operateDom}e.innerHTML=e.innerHTML+m.evaluate(b);var j=f.down("a.com_bbs");var h=parseInt(j.innerHTML.replace('<i title="评论"></i>',"").replace("<I title=评论></I>",""),10);j.innerHTML='<i title="评论"></i>'+(h+1);var o=$("vText"+d);o.value="点击获取验证码";var n=$("vimgArea"+d);n.innerHTML="";var c=$("tbox"+d);c.value=""}},showReplyCommentAreaBox:function(a,b){var c=new StringBuilder();c.append('<div class="mt6 clearfix"><div class="mt9">');c.append("<p "+((this.userInfo.isAnonymous&&this.allowAnonymousComment)?"":'style="display:none;"')+' class="mb12" id="vArea'+a+'">验证码：<input type="text" style="width:90px;" id="vText'+a+'" method="code" class="c_a5" value="点击获取验证码">');c.append('<span id="vimgArea'+a+'"></span></p><a method="submit" href="#" onclick="return false;" class="replaybtn">回复</a><span class="c_red fr mr9 pt3" id="msg'+a+'"></span><p class="pt3 c_a5" _type="fd">还可以输入210字</p></div></div>');return c.toString()},cancelOperateCommentAreaBox:function(a){var b=$("tboxOperate"+a);if(b){b.up("div").previous().show();b.up("div").next("p").down("span").show();b.up("div").remove()}},onClickCommentList:function(j){var b=Event.element(j);var h=b.up("dd");if(!h){return}if(b!=document&&b.hasAttribute("method")){var m=b.readAttribute("method");if(m){Event.stop(j)}var f=h.getElementsBySelector("ul")[0];var e=h.readAttribute("commentid");switch(m){case"comment":if(window.lostFours!=undefined){clearTimeout(window.lostFours)}var t=b.readAttribute("toggle");if(typeof t==="undefined"||t!=="1"){b.setAttribute("toggle","1")}else{return}this.oldClickElementHtml=b.value;this.textarea=b;b.value="";b.style.height="60px";var p=b.up(".ele_replay");var r=b.up();r.style.height="60px";r.addClassName("focus");var o=Builder.build(this.showReplyCommentAreaBox(e,""));p&&p.appendChild(o);CommentAutoHeight.startAuto(b);break;case"comment2":$("tbox"+e).click();break;case"edit":var l=h.readAttribute("loaded");var k=b.up("li");if(k&&k.hasAttribute("commentid")){e=k.readAttribute("commentid")}var q=b.up("p");var g=q.previous().innerHTML;q.previous().hide();b.up("span").hide();var c=Builder.build(this.showOperateCommentAreaBox(e,g));if(k&&k.hasAttribute("commentid")){$(k).insertBefore(c,q)}else{q.up("div").insertBefore(c,q)}break;case"del":$alert("确定要删除这条评论吗？",function(){var B=b.up("li");if(B&&B.hasAttribute("commentid")){e=B.readAttribute("commentid")}this.deleteCommentCallback(this.commentObjId,this.cmsRelatedObjType,e,function(C){if(C&&C.value){if(C.value.status==1){if(B&&B.hasAttribute("commentid")){$(B).remove()}else{$(h).remove()}}$alert(C.value.msg)}})}.bind(this));break;case"reply":var l=h.readAttribute("loaded");if(l=="0"){if(this.isDetailPage&&!this.isStaticComment){f.innerHTML=this.getRepliesHtmlByCommentId(e)}var u=h.getElementsByClassName("user_conter")[0];u.innerHTML=u.innerHTML+this.showReplyCommentAreaBox(e,"");h.setAttribute("loaded","1");new Textbox({text:$("tbox"+e),watermarkText:"输入简短评论..",focusClassName:"",blurClassName:"c_a5"})}this.toggleReply(h);break;case"cancel":var k=b.up("li");if(k&&k.hasAttribute("commentid")){e=k.readAttribute("commentid")}this.cancelOperateCommentAreaBox(e);if(!b.hasAttribute("operate")){this.toggleReply(h);var s=$("tbox"+e);s.value="";new Textbox({text:s,watermarkText:"输入简短评论..",focusClassName:"",blurClassName:"c_a5"})}break;case"code":if(window.lostFours!=undefined){clearTimeout(window.lostFours)}if(b.value=="点击获取验证码"){b.value="";this.server.refreshVcode(function(B){if(B&&B.value){$("vimgArea"+e).innerHTML='<img src="'+B.value.src+'" width="120" height="60" class="v_m mr10 ml10" codeid="'+B.value.id+'" /><a href="#" method="refresh">刷新</a>'}}.bind(this))}break;case"refresh":this.server.refreshVcode(function(B){if(B&&B.value){$("vimgArea"+e).innerHTML='<img src="'+B.value.src+'" width="120" height="60" class="v_m mr10 ml10" codeid="'+B.value.id+'" /><a href="#" method="refresh">刷新</a>'}}.bind(this));break;case"submit":var n=$("msg"+e);var v=$("vArea"+e);var y=$("vimgArea"+e);var z=$("vText"+e);var d=$("tbox"+e);var a="";var k=b.up("li");if(k&&k.hasAttribute("commentid")){a=k.readAttribute("commentid")}if(b.hasAttribute("operate")){if(a.length>0){var n=$("msgOperate"+a);var d=$("tboxOperate"+a)}else{var n=$("msgOperate"+e);var d=$("tboxOperate"+e)}a=a==""?e:a;e=a==""?0:e}else{a=-1;e=e}n.innerHTML="";if(this.userInfo.isAnonymous&&!this.allowAnonymousComment){n.innerHTML="请登录后进行评论";return}var g=d.value.trim();if(g===""||g==="输入简短评论.."){n.innerHTML="请输入评论内容";return}if(g.bytelength()>420){n.innerHTML="评论内容最多为210个汉字";return}var A="";if(z){A=z.value.trim();if(v.visible()&&(A===""||A=="点击获取验证码")){n.innerHTML="请输入验证码";return}}var w="";if(y){var x=y.down("img");if(x){w=x.readAttribute("codeid")}}this.addCommentCallback(this.commentObjId,e,a,g,A,w,0,this.cmsRelatedObjType,b,function(B){if(B.value.commentId){this.completedChildComment(B,e,b);CommentAutoHeight.stopAuto(d)}else{if(B.value.status==-105){if(this.userInfo.isAnonymous){n.innerHTML="验证码输入错误"}else{this.showValidDialog(this.commentObjId,e,a,g,A,w,0,this.cmsRelatedObjType,b)}}else{if(B.value.id){if(!this.userInfo.isAnonymous&&B.value.isUserLogin==false){$alert("请登录后再发表评论");return}z.value="";y.innerHTML='<img src="'+B.value.src+'" width="120" height="60" class="v_m mr10 ml10" codeid="'+B.value.id+'" /><a href="#" method="refresh">刷新</a>'}else{n.innerHTML=B.value.msg}}}}.bind(this));break;default:break}}},getRepliesHtmlByCommentId:function(a){var b=new StringBuilder();var c=this.getRepliesByParentId(this.replies,parseInt(a,10));for(i=0;i<c.length;i++){var d=this.getReplyTemplate(c[i].userId===0);var e=new Template(d);if(c[i].userId>0&&c[i].userId==this.userId){c[i].operate=this.operateDom}b.append(e.evaluate(c[i]))}return b.toString()},toggleReply:function(b){var a=b.getElementsByClassName("my_replies")[0];var c=b.readAttribute("expend");var d;if(c=="0"){if(this.isDetailPage){a.show()}d=b.getElementsByClassName("db_comment_areabox")[0];if(d){d.show()}b.setAttribute("expend","1")}else{if(this.isDetailPage){a.hide()}d=b.getElementsByClassName("db_comment_areabox")[0];if(d){d.hide()}b.setAttribute("expend","0")}},getRepliesByParentId:function(c,b){var a=[];for(i=0;i<c.length;i++){if(c[i].parentId==b){a.push(c[i])}}return a},getNow:function(){var a=new Date();return(a.getFullYear().toString()+"-"+(a.getMonth()+1).toString()+"-"+a.getDate()+" "+a.getHours()+":"+this.padLeft(a.getMinutes()))},padLeft:function(a){if(a.toString().length===1){return"0"+a}else{return a}},close:function(){this.destroyControl();this.destroyEvent();this.destroyDOM()}});var CommentAutoHeight=Class.create();Object.extend(CommentAutoHeight,{getXY:function(e){var f=0,g=0;if(e.getBoundingClientRect){var c=e.getBoundingClientRect();var d=document.documentElement;f=c.left+Math.max(d.scrollLeft,document.body.scrollLeft)-d.clientLeft;g=c.top+Math.max(d.scrollTop,document.body.scrollTop)-d.clientTop}else{for(;e!=document.body;f+=e.offsetLeft,g+=e.offsetTop,e=e.offsetParent){}}return{x:f,y:g}},cssList:["font-family","font-size","font-style","font-weight","font-variant","line-height","margin-top","margin-bottom","margin-left","margin-right","overflow-x","overflow-y","padding-top","padding-bottom","padding-left","padding-right","word-break","word-wrap"],startAuto:function(a){a=$(a);lengthExpMax=210;normalTemplate="还可以输入{0}字";warnTemplate='<span class="c_red">字数超出{0}字</span>';this.handler=CommentAutoHeight.auto.bind(a);Event.observe(a,"blur",this.handler);Event.observe(a,"focus",this.handler);Event.observe(a,"keyup",this.handler);Event.observe(a,"mouseup",this.handler);return CommentAutoHeight.stopAuto.bind(a,this.handler)},auto:function(c){var n=this.up(".ele_replay").down('[_type="fd"]');var k=this.up();if(this.value.length==0){this.style.height="";n.innerHTML=String.format(normalTemplate,[lengthExpMax]);if(c.type==="blur"){window.lostFours=window.setTimeout(function(){CommentAutoHeight.stopAuto(this)}.bind(this),500)}return}if(!CommentAutoHeight.mirrorCtn){CommentAutoHeight.mirrorCtn=$(Builder.node("div"));document.body.appendChild(CommentAutoHeight.mirrorCtn);CommentAutoHeight.mirrorCtn.style.opacity="0";CommentAutoHeight.mirrorCtn.style.zIndex=-1000;CommentAutoHeight.mirrorCtn.style.position="absolute"}mirrorCtn=CommentAutoHeight.mirrorCtn;cssList=CommentAutoHeight.cssList;styleObj={};for(var d=0,e=cssList.length,a,m,g;d<e;++d){a=cssList[d];if((m=this.getStyle(a))){styleObj[a]=m}}mirrorCtn.setStyle(styleObj);mirrorCtn.setStyle({width:this.offsetWidth+"px"});var p=this.value;if(p.lastIndexOf("\n")!=-1&&p.lastIndexOf("\n")+1==p.length){p+="占"}mirrorCtn.innerHTML=p.replace(/\n/g,"<br/>");var j=CommentAutoHeight.getXY(this);mirrorCtn.style.top=j.y+"px";mirrorCtn.style.left=j.x+"px";var h=mirrorCtn.offsetHeight;if(h<60){h=60}k.style.height=this.style.height=h+"px";if(p){var f=Widgets.Utils.strLen(p),b;if(f>0){b=lengthExpMax-f;if(b>=0){$(n).innerHTML=String.format(normalTemplate,[b])}else{$(n).innerHTML=String.format(warnTemplate,[Math.abs(b)])}}}n=k=h=null},stopAuto:function(a){var b=a.up();var c=b.up(".ele_replay").down(".mt6");c&&c.remove();a.value="发表评论";b.removeClassName("focus");a.setAttribute("toggle","0");a.style.height="30px";b.style.height="30px";Event.stopObserving(a,"blur",CommentAutoHeight.handler);Event.stopObserving(a,"focus",CommentAutoHeight.handler);Event.stopObserving(a,"keyup",CommentAutoHeight.handler);Event.stopObserving(a,"mouseup",CommentAutoHeight.handler)}});