var FavoriteControlStyleType={FloatStyle:1,ListStyle:2,SCMStyle:3};var FavoriteCategoryControl=Class.create();Object.extend(FavoriteCategoryControl.prototype,{FAVORITE_CATEGORY_NAME_DEFAULT_TXT:"新分类名称",FAVORITE_CATEGORY_NAME_MAX_LENGTH:25,FAVORITE_CATEGORY_NAME_MAX_DESCRIPTION:"分类名不能超过{0}个字",closed:false,favoriteCategories:[],favoriteDialog:null,selectedCategoryBtn:null,favoriteCategoryListRegion:null,newCategoryTextId:null,newCategoryBtn:null,newCategoryControlBtn:null,newCategoryItemId:null,htmlElement:"li",isFloatStyle:true,server:{getFavoriteCategorys:function(d,c,b,a){if(siteCommunityServiceUrl){return Mtime.Component.Ajax.crossDomainCallBack(siteCommunityServiceUrl,"Mtime.Community.Services.CommunityService","GetFavoriteCategorys2",[d,c,b],a,"/community.api?Ajax_CallBack=true","post","20000")}},addToFavorate:function(e,c,a,d,b){if(siteCommunityServiceUrl){return Mtime.Component.Ajax.crossDomainCallBack(siteCommunityServiceUrl,"Mtime.Community.Services.CommunityService","AddToFavorate102",[e,c,a,d],b,"/community.api?Ajax_CallBack=true","post","20000")}},createCategory:function(a,b){if(siteCommunityServiceUrl){return Mtime.Component.Ajax.crossDomainCallBack(siteCommunityServiceUrl,"Mtime.Community.Services.CommunityService","CreateFavoriteCategory2",[a],b,"/community.api?Ajax_CallBack=true","post","20000")}}},initialize:function(a){this.favoriteCategoryListRegion=a.favoriteCategoryListRegionObj;this.favoriteDialog=a;this.load();this.server.getFavoriteCategorys(this.favoriteDialog.relatedObjType,this.favoriteDialog.relatedObjId,true,function(){var b=getFavoriteCategorysResult;if(b&&b.value){if(!b.value.isLogin){if(typeof UserLoginDialog!="undefined"){var c=new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs(["/js/2014/UserLoginDialog.js"],function(){var d=new UserLoginDialog({callback:function(){location.reload()}})})}return}this.favoriteCategories=b.value.categorys;this.favoriteCountWithoutCategory=b.value.favoriteCountWithoutCategory;this.favoriteDialog.isLogin=b.value.isLogin;this.favoriteDialog.hasFavorite=b.value.hasFavorited;if(this.favoriteDialog.hasFavorite){this.favoriteDialog.favoriteButtonText.innerHTML="已收藏";if(!this.favoriteDialog.favoriteButton.hasClassName("curron")&&this.favoriteDialog.favoriteControlStyleType==FavoriteControlStyleType.FloatStyle){this.favoriteDialog.favoriteButton.addClassName("curron");this.favoriteDialog.favoriteButton.title="已收藏"}this.buildFavoriteCategoryListRegion();this.initializeDOM();this.initializeEvent();if(b.value.isLogin){this.favoriteDialog.favoriteContainer.show();this.favoriteDialog.favoriteButton.addClassName("curr")}}else{this.server.addToFavorate(this.favoriteDialog.relatedObjType,this.favoriteDialog.relatedObjId,0,"",function(){var d=addToFavorateResult;if(d&&d.value){if(!this.favoriteDialog.favoriteButton.hasClassName("curron")&&this.favoriteDialog.favoriteControlStyleType==FavoriteControlStyleType.FloatStyle){this.favoriteDialog.favoriteButton.addClassName("curron");this.favoriteDialog.favoriteButton.title="已收藏"}this.favoriteDialog.hasFavorite=true;this.favoriteDialog.favoriteButtonText.innerHTML="已收藏"}this.buildFavoriteCategoryListRegion();this.initializeDOM();this.initializeEvent();this.favoriteDialog.favoriteContainer.show();this.favoriteDialog.favoriteButton.addClassName("curr")}.bind(this))}}}.bind(this))},initializeDOM:function(){this.selectedCategoryBtn=this.favoriteDialog.selectedCategoryObj},destroyDOM:function(){this.selectedCategoryBtn=null;this.favoriteDialog=null;this.favoriteCategories=[];this.favoriteCategoryListRegion=null;this.newCategoryTextId=null;this.newCategoryBtn=null;this.newCategoryControlBtn=null;this.newCategoryItemId=null},initializeEvent:function(){this.onClickSelectedCategoryBtnHandler=this.onClickSelectedCategoryBtn.bindAsEventListener(this);Event.observe(this.selectedCategoryBtn,"click",this.onClickSelectedCategoryBtnHandler);this.onClickNewCategoryBtnHandler=this.onClickNewCategoryBtn.bindAsEventListener(this);Event.observe(this.newCategoryBtn,"click",this.onClickNewCategoryBtnHandler)},destroyEvent:function(){Event.stopObserving(this.onClickSelectedCategoryBtn,"click",this.onClickSelectedCategoryBtnHandler);Event.stopObserving(this.onClickNewCategoryBtn,"click",this.onClickNewCategoryBtnHandler);this.favoriteCategoryListRegion.getElementsBySelector(this.htmlElement).each(function(c){var a=c.readAttribute("categoryId");if(typeof(a)!="undefined"){var b=Event.findElement(c,this.htmlElement);Event.stopObserving(b,"click",this.onClickAddFavoriteBtnHandler)}})},buildCategoryItem:function(c,d,b){var a=Builder.node(this.htmlElement,{categoryId:c},[Builder.node("a",{href:"#",method:"selectCategory"},[d])]);this.onClickAddFavoriteBtnHandler=this.onClickAddFavoriteBtn.bindAsEventListener(this);Event.observe(a,"click",this.onClickAddFavoriteBtnHandler);return a},buildNewCategoryItem:function(){this.newCategoryControlBtn=Builder.node(this.htmlElement,{},[Builder.node("a",{href:"#",method:"selectCategory"},[Builder.node("i",{className:"ico_t_add"}),"新分类"])]);return this.newCategoryControlBtn},buildAddTextCategoryItem:function(){this.newCategoryTextId=Builder.node("input",{className:"colltxt",type:"text"});this.newCategoryBtn=Builder.node("input",{className:"btn",type:"button"});if(this.isFloatStyle){this.newCategoryItemId=Builder.node("li",{},[Builder.node("div",{className:"addcollsec clearfix"},[this.newCategoryTextId,this.newCategoryBtn])])}else{this.newCategoryItemId=Builder.node("div",{className:"addcollsec clearfix"},[this.newCategoryTextId,this.newCategoryBtn])}return this.newCategoryItemId},buildFavoriteCategoryListRegion:function(){this.favoriteCategoryListRegion.appendChild(this.buildCategoryItem(0,"未分类",this.favoriteCountWithoutCategory));this.favoriteCategories.each(function(a){this.favoriteCategoryListRegion.appendChild(this.buildCategoryItem(a.Id,a.Name,a.Count))}.bind(this));this.favoriteCategoryListRegion.appendChild(this.buildAddTextCategoryItem())},onClickSelectedCategoryBtn:function(b){htmlElement="dl";if(!this.isFloatStyle){htmlElement="div"}var a=Event.findElement(b,htmlElement);if(a.hasClassName("curr")){a.removeClassName("curr");if(this.favoriteDialog.categoryContrainerObj.visible()){this.favoriteDialog.categoryContrainerObj.hide()}}else{a.addClassName("curr");if(!this.favoriteDialog.categoryContrainerObj.visible()){this.favoriteDialog.categoryContrainerObj.show()}}Event.stop(b)},onClickNewCategoryControlBtn:function(a){if(this.newCategoryItemId){if(!this.newCategoryItemId.visible()){this.newCategoryItemId.show()}else{this.newCategoryItemId.hide()}}Event.stop(a)},onClickNewCategoryBtn:function(b){Event.stop(b);var a=this.newCategoryTextId.value.trim();if(a.length>0){if(a.bytelength()>50){$alert("分类名不要超过25个汉字！");return}this.server.createCategory(a,function(){var c=createFavoriteCategoryResult;if(c&&c.value){this.createCategoryCallback(c.value)}else{$alert("添加分类失败，请稍候重试")}}.bind(this))}else{$alert("分类名不能为空！")}},createCategoryCallback:function(c){var a=c.id;var b=c.name;if(this.favoriteCategories!==null){this.favoriteCategories.push({Id:a,Name:b});var d=this.buildCategoryItem(a,b,this.favoriteCategories.Count);this.favoriteCategoryListRegion.insertBefore(d,this.newCategoryItemId);this.newCategoryTextId.value=""}},addToFavoriteCallback:function(){var a=addToFavorateResult;if(a&&a.value){this.favoriteDialog.hasFavorite=true;this.favoriteDialog.favoriteButtonText.innerHTML="已收藏";this.favoriteDialog.favoriteContainer.hide();this.favoriteDialog.favoriteButton.removeClassName("curr")}else{$alert("添加收藏失败，请稍候重试")}Event.stop()},onClickAddFavoriteBtn:function(c){var b=Event.findElement(c,this.htmlElement);var a=b.readAttribute("categoryId");this.server.addToFavorate(this.favoriteDialog.relatedObjType,this.favoriteDialog.relatedObjId,a,"",this.addToFavoriteCallback.bind(this));Event.stop(c)},load:function(){if(this.favoriteDialog.favoriteControlStyleType==FavoriteControlStyleType.FloatStyle){this.htmlElement="li"}else{if(this.favoriteDialog.favoriteControlStyleType==FavoriteControlStyleType.ListStyle){this.htmlElement="p";this.isFloatStyle=false}}},close:function(){if(!this.closed){this.closed=true;this.destroyEvent();this.destroyDOM()}}});var FavoriteButtonControl=Class.create();Object.extend(FavoriteButtonControl.prototype,{name:"FavoriteButtonControl",closed:false,relatedObjType:0,relatedObjId:0,hasFavorited:false,observer:null,favoriteButton:null,favoriteContainer:null,favoriteButtonText:null,favoriteCategoryControl:null,options:{isLogin:false,signInUrl:"",relatedObjId:0,relatedObjType:0,shareRelatedObjType:0,hasFavorited:false,favoriteButton:"",onFavoriteOKCallback:null,favoriteControlStyleType:FavoriteControlStyleType.FloatStyle,callback:null,expandMovieId:0},FavoriteTweet:function(c,b,a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.TwitterService","FavoriteTweet",[c],a,"/Service/Twitter.msi","get","20000",b)},getFavoriteCategorys:function(d,c,b,a){if(siteCommunityServiceUrl){return Mtime.Component.Ajax.crossDomainCallBack(siteCommunityServiceUrl,"Mtime.Community.Services.CommunityService","GetFavoriteCategorys2",[d,c,b],a,"/community.api?Ajax_CallBack=true","post","20000")}},setOptions:function(a){Object.extend(Object.extend(this,this.options),a)},initialize:function(a){this.setOptions(a);if(this.signInUrl){this.signInUrl=this.signInUrl+"/operation/?redirectUrl="+encodeURIComponent(location.href)}else{this.signInUrl=siteMcUrl+"/member/signin/operation/?redirectUrl="+encodeURIComponent(location.href)}if(this.shareRelatedObjType!=="9992"&&this.shareRelatedObjType!=="6401"){this.initializeField();this.initializeDOM();this.initializeControl();this.initializeEvent();this.load();this.render()}else{this.getFavoriteCategorys(this.relatedObjType,this.relatedObjId,true,function(){var b=getFavoriteCategorysResult;if(b&&b.value){if(!b.value.isLogin){if(typeof UserLoginDialog!="undefined"){var c=new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs(["/js/2014/UserLoginDialog.js"],function(){var d=new UserLoginDialog({callback:function(){location.reload()}})})}}else{this.isLogin=true;this.FavoriteTweet(this.relatedObjId,this.favoriteButton,function(e){if(e&&e.value){var d=[];if(this.favoriteControlStyleType==FavoriteControlStyleType.FloatStyle){d.push('<p><i class="ico_t_coll"></i><span>已收藏</span></p>')}else{if(this.favoriteControlStyleType==FavoriteControlStyleType.ListStyle){d.push('<p><i class="ico_t_coll"></i><span>已收藏</span></p>')}}this.favoriteContainer.innerHTML=d.join("");this.favoriteContainer.show();this.favoriteContainer.addClassName("onlycollect");this.favoriteButton.addClassName("curr");this.initializeEvent()}else{$alert("电影微评收藏失败")}}.bind(this))}}}.bind(this))}Event.observe(window,"unload",this.close.bind(this))},initializeField:function(){},initializeDOM:function(){var a=[];this.favoriteCategoryListRegionObj;this.selectedCategoryObj;this.categoryContrainer;this.categoryContrainerSelectedObj;var b=Builder.node("p",{},[Builder.node("i",{className:"ico_t_coll"}),Builder.node("span",{},["收 藏"])]);if(this.favoriteControlStyleType==FavoriteControlStyleType.FloatStyle){this.favoriteCategoryListRegionObj=Builder.node("ul",{});this.selectedCategoryObj=Builder.node("dt",{},[Builder.node("i",{className:"ico_t_collsec"}),Builder.node("span",{},["请选择分类"])]);this.categoryContrainerObj=Builder.node("dd",{},[this.favoriteCategoryListRegionObj]);this.categoryContrainerSelectedObj=Builder.node("dl",{},[this.selectedCategoryObj,this.categoryContrainerObj]);this.favoriteContainer.appendChild(b);this.favoriteContainer.appendChild(this.categoryContrainerSelectedObj)}else{if(this.favoriteControlStyleType==FavoriteControlStyleType.ListStyle){this.favoriteCategoryListRegionObj=Builder.node("div",{className:"hidbox"});this.selectedCategoryObj=Builder.node("strong",{},[Builder.node("i",{className:"ico_t_collsec"}),Builder.node("span",{},["请选择分类"])]);this.categoryContrainerObj=this.favoriteCategoryListRegionObj;this.categoryContrainerSelectedObj=Builder.node("div",{className:"showcoll"},[this.selectedCategoryObj,this.favoriteCategoryListRegionObj]);this.favoriteContainer.appendChild(b);this.favoriteContainer.appendChild(this.categoryContrainerSelectedObj)}else{throw"favoriteControlStyleType does not implemented!"}}this.favoriteButtonText=this.favoriteContainer.getElementsBySelector("p span")[0]},destroyDOM:function(){this.favoriteButton=null;this.favoriteButtonText=null;this.favoriteContainer=null;this.favoriteCategories=[];this.favoriteCategoryListRegion=null},initializeEvent:function(){this.onClickFavoriteButtonHandler=this.onClickFavoriteButton.bindAsEventListener(this);this.favoriteButton.observe("click",this.onClickFavoriteButtonHandler)},destroyEvent:function(){this.favoriteButton.stopObserving("click",this.onClickFavoriteButtonHandler)},initializeControl:function(){this.favoriteCategoryControl=new FavoriteCategoryControl(this)},destroyControl:function(){this.favoriteCategoryControl=null},load:function(){},render:function(){if(this.hasFavorited){this.favoriteButtonText.innerHTML="已收藏";if(!this.favoriteButton.hasClassName("curron")&&this.favoriteControlStyleType==FavoriteControlStyleType.FloatStyle){this.favoriteButton.addClassName("curron");this.favoriteButton.title="已收藏"}}else{this.favoriteButtonText.innerHTML="收 藏"}},onClick:function(c){var b=Event.findElement(c,"div");if(b&&b.readAttribute){var a=b.readAttribute("class");if(a=="addcollsec clearfix"){return}}if(this.favoriteButton){this.favoriteButton.removeClassName("curr")}if(this.favoriteContainer){this.favoriteContainer.hide()}},onClickFavoriteButton:function(b){var a=Event.findElement(b,"div");var c=a.hasClassName("curr");if(this.callback){this.callback(a)}if(!this.isLogin){if(typeof UserLoginDialog!="undefined"){var d=new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs(["/js/2014/UserLoginDialog.js"],function(){var e=new UserLoginDialog({callback:function(){location.reload()}})})}}else{if(c){a.removeClassName("curr");if(this.favoriteContainer){this.favoriteContainer.hide()}}else{if(a.hasClassName("notcurr")){a.removeClassName("notcurr")}a.addClassName("curr");if(this.categoryContrainerObj){this.categoryContrainerObj.hide();if(this.categoryContrainerSelectedObj){if(this.categoryContrainerSelectedObj.hasClassName("curr")){this.categoryContrainerSelectedObj.removeClassName("curr")}}}if(this.favoriteContainer){this.favoriteContainer.show()}}}Event.stop(b)},onFavoriteControlDialogOKCallback:function(a){this.hasFavorited=a.success;this.favoritedCount=a.favoritedCount;this.render();if(this.onFavoriteOKCallback){this.onFavoriteOKCallback(a)}},close:function(){if(!this.closed){this.closed=true;this.destroyControl();this.destroyEvent();this.destroyDOM()}}});var FavoriteButtonControlSCM=Class.create();Object.extend(FavoriteButtonControlSCM.prototype,{name:"FavoriteButtonControlSCM",closed:false,hasFavorited:false,observer:null,favoriteButton:null,options:{goodsId:0,isLogin:false,signInUrl:"",hasFavorited:false,favoriteButton:"",favoriteControlStyleType:FavoriteControlStyleType.SCMStyle,callback:null},hasIsLogin:function(c,b,a){if(siteCommunityServiceUrl){return Mtime.Component.Ajax.crossDomainCallBack(siteCommunityServiceUrl,"Mtime.Community.Services.CommunityService","HasIsLogin",[c,b],a,"/community.api?Ajax_CallBack=true","post","20000")}},addFavoritedSCM:function(b,a){if(siteCommunityServiceUrl){return Mtime.Component.Ajax.crossDomainCallBack(siteCommunityServiceUrl,"Mtime.Community.Services.CommunityService","AddFavoritedSCM",[b],a,"/community.api?Ajax_CallBack=true","post","20000")}},removeFavoritedSCM:function(b,a){if(siteCommunityServiceUrl){return Mtime.Component.Ajax.crossDomainCallBack(siteCommunityServiceUrl,"Mtime.Community.Services.CommunityService","RemoveFavoritedSCM",[b],a,"/community.api?Ajax_CallBack=true","post","20000")}},setOptions:function(a){Object.extend(Object.extend(this,this.options),a)},clickFavorite:function(){this.hasIsLogin(this.goodsId,true,function(){var a=getLoginAndFavoriteResult;if(a&&a.value){if(!a.value.isLogin){if(typeof UserLoginDialog!="undefined"){var b=new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs(["/js/2014/UserLoginDialog.js"],function(){var c=new UserLoginDialog({callback:function(){location.reload()}})})}}else{this.isLogin=true;if(typeof a.value.hasFavorited!="undefined"){if(a.value.hasFavorited){this.removeFavoritedSCM(this.goodsId,function(){if(removeFavoriteSCMResult&&removeFavoriteSCMResult.value&&typeof removeFavoriteSCMResult.value.success!="undefined"){if(removeFavoriteSCMResult.value.success){if(this.favoriteButton.hasClassName("on")){this.favoriteButton.removeClassName("on")}}else{$alert("取消收藏失败")}}else{$alert("取消收藏异常")}}.bind(this))}else{this.addFavoritedSCM(this.goodsId,function(){if(addFavoriteSCMResult&&addFavoriteSCMResult.value&&typeof addFavoriteSCMResult.value.success!="undefined"){if(addFavoriteSCMResult.value.success){if(!this.favoriteButton.hasClassName("on")){this.favoriteButton.addClassName("on")}}else{$alert("添加收藏失败")}}else{$alert("添加收藏异常")}}.bind(this))}}}}}.bind(this))},initialize:function(a){this.setOptions(a);if(this.signInUrl){this.signInUrl=this.signInUrl+"/operation/?redirectUrl="+encodeURIComponent(location.href)}else{this.signInUrl=siteMcUrl+"/member/signin/operation/?redirectUrl="+encodeURIComponent(location.href)}this.clickFavorite();Event.observe(window,"unload",this.close.bind(this))},initializeField:function(){},initializeDOM:function(){},destroyDOM:function(){this.favoriteButton=null},initializeEvent:function(){},destroyEvent:function(){},initializeControl:function(){},destroyControl:function(){},load:function(){},render:function(){},close:function(){if(!this.closed){this.closed=true;this.destroyControl();this.destroyEvent();this.destroyDOM()}}});