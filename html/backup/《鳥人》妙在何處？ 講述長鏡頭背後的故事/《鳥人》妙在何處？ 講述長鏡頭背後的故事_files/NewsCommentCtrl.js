var NewsCommentCtrl=Class.create();Object.extend(NewsCommentCtrl.prototype,{relatedObjType:0,options:{commentRegionId:"",isReviewDetailPage:false,isMediaReviewDetailPage:false,newsId:"",newsTitle:"",newsUrl:""},setOptions:function(a){Object.extend(Object.extend(this,this.options),a)},server:{loadData:function(b,a,c){return Mtime.Component.Ajax.crossDomainCallBack(siteLibraryServiceUrl,"Mtime.Library.Services","GetNewsCommentCountInfo",[b],a,"/CMS.api","get","60000",c)},addOrDelPraiseLog:function(b,c,a,d){return Mtime.Component.Ajax.crossDomainCallBack(siteLibraryServiceUrl,"Mtime.Library.Services","AddOrDelPraiseLog",[b,c],a,"/Movie.api","get","60000",d)},addTranspond:function(b,c,a,d){return Mtime.Component.Ajax.crossDomainCallBack(siteLibraryServiceUrl,"Mtime.Library.Services","AddTranspondLog",[b,c],a,"/Movie.api","get","60000",d)}},initialize:function(a){this.setOptions(a);this.initializeServerData();this.initializeDOM();this.initializeEvent();this.initializeControl();this.load()},initializeServerData:function(){},initializeDOM:function(){this.commentRegion=$("commentRegion")},destroyDOM:function(){this.commentRegion=null},initializeEvent:function(){this.onClickCommentRegionHandler=this.onClickCommentRegion.bind(this);this.commentRegion&&Event.observe(this.commentRegion,"click",this.onClickCommentRegionHandler);Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){this.commentRegion&&Event.stopObserving(this.commentRegion,"click",this.onClickCommentRegionHandler)},initializeControl:function(){if(this.commentRegion){this.showTweetEnterTime(this.commentRegionId)}},destroyControl:function(){if(this.ShareControlList){this.ShareControlList.each(function(a){a.value.close();a=null})}},load:function(){this.loadData()},loadData:function(){var a="";if(this.commentRegion){a=this.getObjIds(this.commentRegion,"commentId")}if(a.length>0){this.server.loadData(a,function(b){if(b&&b.value){if(b.value.commentPraiseCount){this.setCommentCount(this.commentRegion,"com_good",b.value.commentPraiseCount,"赞")}if(b.value.commentPraiseStatus){this.setPraiseStatus(this.commentRegion,"com_good",b.value.commentPraiseStatus)}if(b.value.commentShareCount){this.setCommentCount(this.commentRegion,"com_share",b.value.commentShareCount,"转发")}}}.bind(this),null)}},getObjIds:function(c,b){if(c){var h;if(this.isReviewDetailPage){h=c.getElementsByClassName("com_good")}else{h=c.getElementsByClassName("com_bbs")}if(h&&h.length>0){var g;var e;var a=[];for(var d=0,f=h.length;d<f;d++){g=$(h[d]);e=g.parentNode.getAttribute(b);if(e){a.push(e)}}return a.join(",")}}return""},setCommentCount:function(d,b,c,j){if(d){var h=d.getElementsByClassName(b);if(h&&h.length>0){var g;var a=[];for(var e=0,f=h.length;e<f;e++){g=$(h[e]);if(this.isReviewDetailPage){if(c[e]>0){g.innerHTML=String.format('<i title="{0}"></i>赞{1}',j,c[e])}else{g.innerHTML=String.format('<i title="{0}"></i>赞',j)}}else{g.innerHTML=String.format('<i title="{0}"></i>{1}',j,c[e])}}}}},setPraiseStatus:function(c,b,h){if(c){var g=c.getElementsByClassName(b);if(g&&g.length>0){var f;var a=[];for(var d=0,e=g.length;d<e;d++){if(h[d]){f=$(g[d]);f.addClassName("on")}}}}},showTweetEnterTime:function(a){var b=$$("a[entertime]");this.setTweetEnterTime(b);if(a==="commentRegion"){var c=$$("span[entertime]");if(c.length===0){c=$$("p[entertime]")}if(c.length>0){this.setTweetEnterTime(c)}}},setTweetEnterTime:function(a){a.each(function(c){var b=c.getAttribute("entertime");if(!Mtime.isEmpty(b)){var d=this.getTweetShowTime(b);c.innerHTML=d}}.bind(this))},getTweetShowTime:function(c){var a=new Date();var h=c.match(/^ *(\d{4})-(\d{1,2})-(\d{1,2}) +(\d{1,2}):(\d{1,2}):(\d{1,2}) *$/);if(h&&h.length>6){a=new Date(parseInt(h[1]),parseInt(h[2])-1,parseInt(h[3]),parseInt(h[4]),parseInt(h[5]),parseInt(h[6]))}var g=new Date();var j=g.getTime()-a.getTime();if(j>0){var b=Math.floor(j/(1000*60*60*24));var e=Math.floor(j/(1000*3600))-(b*24);var f=Math.floor(j/(1000*60))-(b*24*60)-(e*60);var i=Math.floor(j/(1000))-(b*24*60*60)-(e*60*60)-(f*60);if(b>0){if(b===1){return a.toString("昨天 HH:mm")}else{if(b===2){return a.toString("前天 HH:mm")}}return a.toString("MM月dd日 HH:mm")}if(e>0){return e+"小时前"}if(f>0){return f+"分钟前"}return i+"秒前"}return c},onClickCommentRegion:function(a){this.onClickRegion(a,72,"commentid")},onClickRegion:function(b,f,d){var a=Event.findElement(b,"a");if(a!==document&&a.tagName==="A"&&a.hasAttribute("method")){var e=a.getAttribute("method");var c=a.parentNode.getAttribute(d);if(!Mtime.isEmpty(e)&&c&&c.length>0){if(e==="praise"){this.addOrDelPraise(a,c,f)}else{if(e==="share"){this.addTranspond(a,c,f)}}}}},addOrDelPraise:function(a,b,c){this.server.addOrDelPraiseLog(b,c,function(d){if(d&&d.value){if(!d.value.isLogin){new UserLoginDialog({callback:function(){location.reload()}})}else{if(d.value.success){if(d.value.isAdd){a.addClassName("on")}else{a.removeClassName("on")}this.updateCount(a,"赞",d.value.totalCount)}}}}.bind(this),a)},addTranspond:function(a,b,f){var e=f.toString()+"_"+b.toString();if(!this.ShareControlList){this.ShareControlList=[]}var g;var c=false;for(var d in this.ShareControlList){if(d.key===e){g=d.value;c=true;break}}if(!c){g=new ShareNewsCommentControl({shareControlStyleType:3,newsId:this.newsId,commentContext:$("tbox"+b).up("div .user_conter").down("p").innerHTML,newsTitle:this.newsTitle,newsUrl:this.newsUrl,shareButton:a,autoLoad:false,shareSuccessCallBack:function(){this.server.addTranspond(b,f,function(h){if(h&&h.value){if(h.value.success&&h.value.totalCount){this.updateCount(a,"转发",h.value.totalCount)}}}.bind(this),a)}.bind(this)});this.ShareControlList.push({key:e,value:g})}else{g.close()}},updateCount:function(b,c,a){if(this.isReviewDetailPage){if(a>0){b.innerHTML=String.format('<i title="{0}"></i>赞{1}',c,a)}else{b.innerHTML=String.format('<i title="{0}"></i>赞',c)}}else{b.innerHTML=String.format('<i title="{0}"></i>{1}',c,a)}},close:function(){this.destroyControl();this.destroyEvent();this.destroyDOM()}});